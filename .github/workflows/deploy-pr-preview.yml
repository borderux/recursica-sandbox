name: Deploy PR Preview

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]
    branches: [main]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

# Allow concurrent deployments for different PRs
concurrency: preview-${{ github.ref }}

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Storybook
        if: github.event.action != 'closed'
        run: npm run build-storybook

      - name: Deploy preview
        id: preview
        uses: rossjrw/pr-preview-action@v1
        with:
          source-dir: ./storybook-static
          preview-branch: gh-pages
          umbrella-dir: pr-preview
          action: auto

      - name: Update PR description with Storybook preview URL
        if: steps.preview.outputs.deployment-action == 'deploy'
        uses: actions/github-script@v7
        env:
          PREVIEW_URL: ${{ steps.preview.outputs.preview-url }}
        with:
          script: |
            const previewUrl = process.env.PREVIEW_URL;
            const prNumber = context.payload.pull_request.number;
            const existingBody = context.payload.pull_request.body || '';
            const previewSection = `\n\n## Storybook preview\n\n[View Storybook preview](${previewUrl})\n`;
            const newBody = existingBody.includes('## Storybook preview')
              ? existingBody.replace(/## Storybook preview[\s\S]*?(?=\n\n##|$)/, `## Storybook preview\n\n[View Storybook preview](${previewUrl})\n`)
              : existingBody + previewSection;
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              body: newBody
            });
